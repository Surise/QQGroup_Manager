<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>天鱼管理页面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/keywords.css">
</head>
<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4">天鱼群管处理页面 for WTBU</h1>
        <div class="card mb-4">
            <div class="card-body">
                <form method="post" action="/keywords" id="add-form" class="row gy-2 gx-3 align-items-center">
                    <div class="col-auto">
                        <input name="keyword" class="form-control" placeholder="关键词" required>
                    </div>
                    <div class="col-auto">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="action" value="reply" id="action-reply" onchange="onActionChangeCheckbox()">
                                <label class="form-check-label" for="action-reply">回复</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="action" value="ban" id="action-ban" onchange="onActionChangeCheckbox()">
                                <label class="form-check-label" for="action-ban">禁言</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="action" value="kick" id="action-kick" onchange="onActionChangeCheckbox()">
                                <label class="form-check-label" for="action-kick">踢出</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="action" value="recall" id="action-recall" onchange="onActionChangeCheckbox()">
                                <label class="form-check-label" for="action-recall">撤回</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <input name="reply" class="form-control" placeholder="回复内容" id="reply-input" style="display:none;">
                    </div>
                    <div class="col-auto">
                        <input name="duration" type="number" class="form-control" placeholder="禁言秒数" id="duration-input" style="display:none;">
                    </div>
                    <input type="hidden" name="idx" value="">
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">添加</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0">
                        <thead class="table-light">
                            <tr><th>关键词</th><th>类型</th><th>回复内容</th><th>禁言秒数</th><th>操作</th></tr>
                        </thead>
                        <tbody>
                        {% for kw in keywords %}
                            <tr>
                                <form method="post" action="/keywords" class="row g-2 align-items-center">
                                <input type="hidden" name="idx" value="{{ loop.index0 }}">
                                <td><input name="keyword" class="form-control" value="{{ kw.keyword }}" required></td>
                                <td>
                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="action" value="reply" id="action-reply-{{ loop.index0 }}" onchange="onRowActionChangeCheckbox(this, {{ loop.index0 }})" {% if 'reply' in (kw.action if kw.action is iterable and not kw.action is string else [kw.action]) %}checked{% endif %}>
                                            <label class="form-check-label" for="action-reply-{{ loop.index0 }}">回复</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="action" value="ban" id="action-ban-{{ loop.index0 }}" onchange="onRowActionChangeCheckbox(this, {{ loop.index0 }})" {% if 'ban' in (kw.action if kw.action is iterable and not kw.action is string else [kw.action]) %}checked{% endif %}>
                                            <label class="form-check-label" for="action-ban-{{ loop.index0 }}">禁言</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="action" value="kick" id="action-kick-{{ loop.index0 }}" onchange="onRowActionChangeCheckbox(this, {{ loop.index0 }})" {% if 'kick' in (kw.action if kw.action is iterable and not kw.action is string else [kw.action]) %}checked{% endif %}>
                                            <label class="form-check-label" for="action-kick-{{ loop.index0 }}">踢出</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="action" value="recall" id="action-recall-{{ loop.index0 }}" onchange="onRowActionChangeCheckbox(this, {{ loop.index0 }})" {% if 'recall' in (kw.action if kw.action is iterable and not kw.action is string else [kw.action]) %}checked{% endif %}>
                                            <label class="form-check-label" for="action-recall-{{ loop.index0 }}">撤回</label>
                                        </div>
                                    </div>
                                </td>
                                <td><input name="reply" class="form-control" value="{{ kw.reply if ('reply' in (kw.action if kw.action is iterable and not kw.action is string else [kw.action])) else '' }}" {% if 'reply' not in (kw.action if kw.action is iterable and not kw.action is string else [kw.action]) %}style="display:none;"{% endif %}></td>
                                <td><input name="duration" type="number" class="form-control" value="{{ kw.duration if ('ban' in (kw.action if kw.action is iterable and not kw.action is string else [kw.action])) else '' }}" {% if 'ban' not in (kw.action if kw.action is iterable and not kw.action is string else [kw.action]) %}style="display:none;"{% endif %}></td>
                                <td>
                                    <button type="submit" class="btn btn-success btn-sm">保存</button>
                                </form>
                                <form method="post" action="/keywords/delete/{{ loop.index0 }}" style="display:inline;">
                                    <button type="submit" class="btn btn-danger btn-sm">删除</button>
                                </form>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-warning" onclick="saveAllKeywords()">全部保存</button>
        </div>
    </div>
    <script src="/static/keywords.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function onActionChangeCheckbox() {
        var addForm = document.getElementById('add-form');
        var replyInput = addForm.querySelector('#reply-input');
        var durationInput = addForm.querySelector('#duration-input');
        var checked = Array.from(addForm.querySelectorAll('input[name="action"]:checked')).map(cb => cb.value);
        if (checked.includes('reply')) {
            replyInput.style.display = '';
        } else {
            replyInput.style.display = 'none';
        }
        if (checked.includes('ban')) {
            durationInput.style.display = '';
        } else {
            durationInput.style.display = 'none';
        }
    }
    function onRowActionChangeCheckbox(checkbox, idx) {
        var row = checkbox.closest('tr');
        var replyInput = row.querySelector('input[name="reply"]');
        var durationInput = row.querySelector('input[name="duration"]');
        var checked = Array.from(row.querySelectorAll('input[name="action"]:checked')).map(cb => cb.value);
        if (checked.includes('reply')) {
            replyInput.style.display = '';
        } else {
            replyInput.style.display = 'none';
        }
        if (checked.includes('ban')) {
            durationInput.style.display = '';
        } else {
            durationInput.style.display = 'none';
        }
    }
    function saveAllKeywords() {
        var table = document.querySelector('table');
        var rows = table.querySelectorAll('tbody tr');
        var keywords = [];
        rows.forEach(function(row) {
            var keyword = row.querySelector('input[name="keyword"]').value.trim();
            var actions = Array.from(row.querySelectorAll('input[name="action"]:checked')).map(cb => cb.value);
            var reply = row.querySelector('input[name="reply"]')?.value.trim() || '';
            var duration = row.querySelector('input[name="duration"]')?.value.trim() || '';
            var kw = {keyword: keyword, action: actions};
            if (actions.includes('reply')) kw.reply = reply;
            if (actions.includes('ban')) kw.duration = duration ? parseInt(duration) : 60;
            keywords.push(kw);
        });
        fetch('/keywords/saveall', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({keywords: keywords})
        }).then(res => {
            if (res.ok) {
                location.reload();
            } else {
                alert('保存失败');
            }
        });
    }
    </script>
</body>
</html> 